<!-- mi_proyecto/mi_app/templates/mi_app/index.html -->
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Metadatos esenciales para la correcta visualización y funcionamiento del sitio -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca de Libros (La Estantería Infinita)</title>
    <!-- Enlace al ícono del sitio (favicon) utilizando la etiqueta 'static' de Django para cargar archivos estáticos -->
    <link rel="icon" type="image/x-icon" href="{% static 'images/libreria.ico' %}">

    <!-- Enlaces a hojas de estilo CSS de Bootstrap y otras librerías externas para dar estilo y funcionalidad -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Hoja de estilos para DataTables, una librería de jQuery para mejorar las tablas HTML -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <!-- Hoja de estilos para Select2, una librería para mejorar los campos de selección -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css">
    <!-- Hoja de estilos para la versión responsiva de DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css">
    <!-- Hoja de estilos personalizada del proyecto, cargada desde los archivos estáticos de Django -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <!-- Hoja de estilos para Font Awesome, que permite usar iconos mediante clases -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Enlace a las fuentes de Google Fonts para mejorar la tipografía del sitio -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <!-- Estilos personalizados en línea -->
    <style>
        /* Puedes mover estos estilos a styles.css si lo prefieres */
        /* Estilo general del cuerpo de la página */
        body {
            font-family: 'Montserrat', 'Roboto', sans-serif; /* Fuente utilizada en toda la página */
            background-color: var(--background-color, #f9f9f9); /* Color de fondo predeterminado */
            color: var(--text-color, #333333); /* Color del texto predeterminado */
            transition: background-color 0.3s, color 0.3s; /* Transición suave al cambiar colores */
        }

        /* Estilo para la barra de navegación */
        .navbar {
            background-color: var(--navbar-color, #343a40) !important; /* Color de fondo de la barra de navegación */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Sombra sutil debajo de la barra de navegación */
        }

        /* Estilo para la marca del sitio en la barra de navegación */
        .navbar-brand {
            color: #ffffff !important; /* Color del texto de la marca */
            font-weight: bold; /* Negrita para resaltar la marca */
            font-size: 1.5rem; /* Tamaño de fuente mayor para destacar la marca */
        }

        /* Estilo para los enlaces de navegación */
        .navbar-nav .nav-link {
            color: #ffffff !important; /* Color predeterminado de los enlaces */
            transition: color 0.3s; /* Transición suave al cambiar el color de los enlaces */
        }

        /* Estilo para los enlaces de navegación al pasar el cursor sobre ellos */
        .navbar-nav .nav-link:hover {
            color: var(--primary-color, #00aaff) !important; /* Cambio de color al pasar el cursor */
        }

        /* Estilo para el botón de cerrar sesión */
        .btn-logout {
            background-color: #dc3545; /* Color de fondo rojo para indicar acción de eliminación o cierre */
            color: #ffffff; /* Color del texto en blanco para contraste */
            border: none; /* Sin borde adicional */
            transition: background-color 0.3s; /* Transición suave al cambiar el color de fondo */
        }

        /* Estilo para el botón de cerrar sesión al pasar el cursor */
        .btn-logout:hover {
            background-color: #c82333; /* Cambio a un tono más oscuro de rojo al pasar el cursor */
        }

        /* Contenedor para tablas y formularios con estilo personalizado */
        .table-container, .form-container {
            background-color: var(--background-color, #ffffff); /* Color de fondo blanco por defecto */
            padding: 30px; /* Espaciado interno generoso */
            border-radius: 8px; /* Bordes redondeados */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Sombra sutil para darle profundidad al contenedor */
            margin-top: 30px; /* Margen superior para separar del contenido anterior */
            transition: background-color 0.3s, color 0.3s; /* Transición suave al cambiar colores */
        }

        /* Estilo para los encabezados principales */
        h1, h2, h3 {
            color: #343a40; /* Color de texto oscuro para los encabezados */
            margin-bottom: 20px; /* Margen inferior para espaciar del contenido siguiente */
        }

        /* Estilo para las instrucciones o descripciones breves */
        .instructions {
            font-size: 0.95rem; /* Tamaño de fuente ligeramente más pequeño */
            color: #6c757d; /* Color de texto gris para diferenciar del contenido principal */
            margin-bottom: 20px; /* Margen inferior para separar de otros elementos */
        }

        /* Estilo para el contenido de los modales */
        .modal-content {
            border-radius: 10px; /* Bordes redondeados para suavizar las esquinas del modal */
        }

        /* Estilo específico para un textarea que no permite redimensionarse */
        #editarTextoComentario {
            resize: none; /* Deshabilita la capacidad de redimensionar el textarea */
        }

        /* Estilo para los encabezados de las tablas de DataTables */
        table.dataTable thead th {
            background-color: #343a40; /* Color de fondo oscuro para los encabezados */
            color: #ffffff; /* Color de texto blanco para contraste */
            text-align: center; /* Alineación centrada del texto */
        }

        /* Estilo para las celdas de las tablas de DataTables */
        table.dataTable tbody td {
            vertical-align: middle; /* Alineación vertical al centro para mejor legibilidad */
        }

        /* Estilo para los botones de acción en las tablas */
        .btn-action {
            margin-right: 5px; /* Margen derecho para separar los botones entre sí */
        }

        /* Estilo para las filas de las tablas de DataTables */
        table.dataTable tbody tr {
            height: 60px; /* Altura fija para cada fila */
        }

        /* Media query para ajustar estilos en pantallas pequeñas (máximo 576px de ancho) */
        @media (max-width: 576px) {
            .navbar-brand {
                font-size: 1.2rem; /* Reducir el tamaño de fuente de la marca en la barra de navegación */
            }
            .table-container, .form-container {
                padding: 20px; /* Reducir el padding de los contenedores para aprovechar el espacio limitado */
            }
        }

        /* Estilos para el modo oscuro utilizando variables CSS */
        body.dark-mode {
            --background-color: #121212; /* Color de fondo oscuro */
            --text-color: #e0e0e0; /* Color de texto claro para contraste */
            --navbar-color: #1f1f1f; /* Color de la barra de navegación en modo oscuro */
            --primary-color: #bb86fc; /* Color primario para elementos interactivos en modo oscuro */
        }

        /* Estilos para los tooltips de Bootstrap */
        .tooltip-inner {
            background-color: #333333; /* Color de fondo oscuro */
            color: #ffffff; /* Color de texto blanco */
            border-radius: 5px; /* Bordes redondeados para suavizar las esquinas del tooltip */
        }

        /* Transición suave para la apertura de modales */
        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out;
        }

        /* Transformación al mostrar el modal */
        .modal.show .modal-dialog {
            transform: translate(0, 0);
        }

        /* Estilos para alertas dinámicas que aparecen en una posición fija */
        #alertContainer .alert {
            position: fixed; /* Posición fija para que las alertas no afecten el flujo de la página */
            top: 80px; /* Espaciado desde la parte superior */
            right: 20px; /* Espaciado desde la derecha */
            z-index: 1050; /* Índice Z alto para asegurarse de que las alertas estén por encima de otros elementos */
            min-width: 300px; /* Ancho mínimo para las alertas */
        }
    </style>
    
    <!-- Variables JavaScript con información del usuario actual -->
    <script>
        const currentUser = '{{ user.username }}'; // Nombre de usuario del usuario actualmente autenticado
        const isAdmin = {{ user.is_staff|yesno:"true,false" }}; // Booleano que indica si el usuario actual es administrador (staff)
    </script>
</head>
<body>
    <!-- Barra de navegación principal, fija en la parte superior de la página -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <!-- Nombre del sitio que generalmente enlaza a la página de inicio -->
            <a class="navbar-brand" href="#">Biblioteca de Libros</a>
            <!-- Botón que aparece en pantallas pequeñas para alternar el menú de navegación -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <!-- Icono del botón de alternar, representado por tres líneas horizontales -->
                <span class="navbar-toggler-icon"></span>
            </button>
            <!-- Contenedor colapsable que contiene los enlaces de navegación -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <!-- Verificación si el usuario es administrador para mostrar opciones adicionales -->
                    {% if isAdmin %}
                    <!-- Enlace para administrar autores, visible solo para administradores -->
                    <li class="nav-item">
                        <a class="nav-link" href="#administrarAutores">Administrar Autores</a>
                    </li>
                    <!-- Enlace para administrar libros, visible solo para administradores -->
                    <li class="nav-item">
                        <a class="nav-link" href="#administrarLibros">Administrar Libros</a>
                    </li>
                    {% endif %}
                    <!-- Enlace para la sección de comentarios, visible para todos los usuarios -->
                    <li class="nav-item">
                        <a class="nav-link" href="#comentarios">Comentarios</a>
                    </li>
                </ul>
                <!-- Formulario para el selector de idioma, utilizando Select2 para mejorar la apariencia -->
                <form class="d-flex">
                    <select id="idiomaSelector" class="form-select">
                        <!-- Opción por defecto seleccionada -->
                        <option value="es" selected>Español</option>
                        <!-- Opción para inglés -->
                        <option value="en">English</option>
                        <!-- Se pueden añadir más opciones de idioma según necesidad -->
                    </select>
                </form>
                <!-- Interruptor para alternar entre tema claro y oscuro -->
                <div class="form-check form-switch ml-3">
                    <!-- Checkbox que actúa como interruptor para el tema oscuro -->
                    <input class="form-check-input" type="checkbox" id="toggleDarkMode">
                    <!-- Etiqueta asociada al interruptor, indicando su función -->
                    <label class="form-check-label text-light" for="toggleDarkMode">Tema Oscuro</label>
                </div>

                <!-- Botón para cerrar sesión, con icono de Font Awesome -->
                <button class="btn btn-logout ml-3" onclick="window.location.href='{% url 'mi_app:logout' %}'" data-toggle="tooltip" title="Cerrar Sesión">
                    <!-- Icono de cerrar sesión -->
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenedor principal de la página, con margen superior para evitar que el contenido quede debajo de la barra de navegación fija -->
    <div class="container mt-5 pt-5">
        <!-- Contenedor para mostrar alertas dinámicas, como mensajes de éxito o error -->
        <div id="alertContainer"></div>

        <!-- Mensaje de bienvenida personalizado al usuario -->
        <div class="text-center mt-4">
            <h3>¡Bienvenido, {{ user.username }}!</h3>
        </div>

        {% if isAdmin %}
        <!-- Sección para administrar autores, visible solo para administradores -->
        <div id="administrarAutores" class="form-container">
            <h2>Administrar Autores</h2>
            <!-- Tabla para listar autores utilizando DataTables -->
            <table id="tablaAutores" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Los datos de los autores serán cargados dinámicamente vía AJAX utilizando DataTables -->
                </tbody>
            </table>

            <!-- Formulario para agregar nuevos autores -->
            <div class="mt-4">
                <h3>Agregar Nuevo Autor</h3>
                <!-- Formulario estructurado en filas y columnas utilizando Bootstrap -->
                <form id="addAuthorForm" class="row g-3">
                    <!-- Token CSRF para protección contra ataques de falsificación de solicitudes entre sitios -->
                    {% csrf_token %}
                    <!-- Campo de entrada para el nombre del autor, ocupando 6 columnas en pantallas medianas -->
                    <div class="col-md-6">
                        <label for="nombreAutor" class="form-label">Nombre del Autor</label>
                        <input type="text" id="nombreAutor" class="form-control" placeholder="Escribe el nombre del autor" required>
                        <!-- Mensaje de retroalimentación en caso de invalidación del campo -->
                        <div class="invalid-feedback">
                            Por favor, ingresa el nombre del autor.
                        </div>
                    </div>
                    <!-- Botón para enviar el formulario, alineado verticalmente al final del campo anterior -->
                    <div class="col-md-6 align-self-end">
                        <button type="submit" class="btn btn-success w-100">Agregar Autor <i class="fas fa-plus-circle"></i></button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Sección para listar y administrar libros -->
        <div id="administrarLibros" class="table-container">
            <h1>Listado de Libros</h1>
            <!-- Instrucciones o descripción sobre cómo interactuar con la tabla de libros -->
            <p class="instructions">
                Aquí puedes ver la lista de libros disponibles en la biblioteca. Usa las opciones para eliminar, editar o ver comentarios.
            </p>
            <!-- Tabla para listar libros utilizando DataTables -->
            <table id="tablaLibros" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Autores</th>
                        <th>Año de Publicación</th>
                        <th>Idioma</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Los datos de los libros serán cargados dinámicamente vía AJAX utilizando DataTables -->
                </tbody>
            </table>
        </div>

        <!-- Sección para agregar nuevos libros -->
        <div class="form-container">
            <h2>Agregar Nuevo Libro</h2>
            <!-- Formulario estructurado en filas y columnas utilizando Bootstrap -->
            <form id="addBookForm" class="row g-3">
                <!-- Token CSRF para protección contra ataques de falsificación de solicitudes entre sitios -->
                {% csrf_token %}
                <!-- Campo de entrada para el título del libro, ocupando 6 columnas en pantallas medianas -->
                <div class="col-md-6">
                    <label for="titulo" class="form-label">Título</label>
                    <input type="text" id="titulo" class="form-control" placeholder="Escribe el título" required>
                    <!-- Mensaje de retroalimentación en caso de invalidación del campo -->
                    <div class="invalid-feedback">
                        Por favor, ingresa el título del libro.
                    </div>
                </div>
                <!-- Campo de entrada para el año de publicación, ocupando 3 columnas en pantallas medianas -->
                <div class="col-md-3">
                    <label for="anio_publicacion" class="form-label">Año de Publicación</label>
                    <input type="number" id="anio_publicacion" class="form-control" placeholder="Ej. 2020" required>
                    <!-- Mensaje de retroalimentación en caso de invalidación del campo -->
                    <div class="invalid-feedback">
                        Por favor, ingresa el año de publicación.
                    </div>
                </div>
                <!-- Campo de entrada para el idioma, ocupando 3 columnas en pantallas medianas -->
                <div class="col-md-3">
                    <label for="idioma" class="form-label">Idioma</label>
                    <input type="text" id="idioma" class="form-control" placeholder="Ej. Español" required>
                    <!-- Mensaje de retroalimentación en caso de invalidación del campo -->
                    <div class="invalid-feedback">
                        Por favor, ingresa el idioma.
                    </div>
                </div>
                <!-- Campo de selección múltiple para los autores, ocupando 12 columnas (toda la fila) -->
                <div class="col-md-12">
                    <label for="autores" class="form-label">Autores</label>
                    <div class="input-group">
                        <!-- Campo de selección mejorado con Select2 para elegir múltiples autores -->
                        <select id="autores" class="form-control" multiple="multiple" required></select>
                        <!-- Botón para abrir el modal de agregar un nuevo autor directamente desde el formulario de libros -->
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" id="addAuthorBtn" title="Agregar Nuevo Autor" data-toggle="tooltip">
                                <i class="fas fa-plus-circle"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Mensaje de retroalimentación en caso de invalidación del campo -->
                    <div class="invalid-feedback">
                        Por favor, selecciona al menos un autor.
                    </div>
                </div>
                <!-- Botón para enviar el formulario y agregar el libro, ocupando 12 columnas (toda la fila) -->
                <div class="col-12">
                    <button type="submit" class="btn btn-success">Agregar Libro <i class="fas fa-plus-circle"></i></button>
                </div>
            </form>
        </div>

        <!-- Sección para gestionar comentarios de libros -->
        <div id="comentarios" class="form-container mt-4">
            <h2>Comentarios</h2>
            <!-- Tabla para listar comentarios utilizando DataTables -->
            <table id="tablaComentarios" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Libro</th>
                        <th>Usuario</th>
                        <th>Comentario</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Los datos de los comentarios serán cargados dinámicamente vía AJAX utilizando DataTables -->
                </tbody>
            </table>
        </div>

        <!-- Modal para agregar un nuevo autor desde el formulario de libros -->
        <div class="modal fade" id="agregarAutorModal" tabindex="-1" role="dialog" aria-labelledby="agregarAutorModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <!-- Formulario dentro del modal para agregar un nuevo autor -->
                    <form id="agregarAutorFormModal">
                        <!-- Token CSRF para protección contra ataques de falsificación de solicitudes entre sitios -->
                        {% csrf_token %}
                        <div class="modal-header">
                            <!-- Título del modal -->
                            <h5 class="modal-title" id="agregarAutorModalLabel">Agregar Nuevo Autor</h5>
                            <!-- Botón para cerrar el modal -->
                            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- Campo de entrada para el nombre del nuevo autor -->
                            <div class="form-group">
                                <label for="nuevoNombreAutor">Nombre del Autor</label>
                                <input type="text" class="form-control" id="nuevoNombreAutor" placeholder="Escribe el nombre del autor" required>
                                <!-- Mensaje de retroalimentación en caso de invalidación del campo -->
                                <div class="invalid-feedback">
                                    Por favor, ingresa el nombre del autor.
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <!-- Botón para cancelar la acción y cerrar el modal -->
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                            <!-- Botón para enviar el formulario y agregar el autor -->
                            <button type="submit" class="btn btn-primary">Agregar Autor</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para ver y gestionar comentarios de un libro específico -->
        <div class="modal fade" id="comentariosModal" tabindex="-1" role="dialog" aria-labelledby="comentariosModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <!-- Título del modal -->
                        <h5 class="modal-title" id="comentariosModalLabel">Comentarios del Libro</h5>
                        <!-- Botón para cerrar el modal -->
                        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Lista para mostrar los comentarios, será llenada dinámicamente -->
                        <ul id="comentariosList" class="list-group mb-3">
                            <!-- Comentarios serán cargados dinámicamente -->
                        </ul>
                        <!-- Área de texto para agregar un nuevo comentario -->
                        <div class="form-group">
                            <label for="nuevoComentario">Agregar Comentario</label>
                            <textarea id="nuevoComentario" class="form-control" rows="3" placeholder="Escribe un comentario" required></textarea>
                            <!-- Mensaje de retroalimentación en caso de invalidación del campo -->
                            <div class="invalid-feedback">
                                Por favor, escribe un comentario antes de guardar.
                            </div>
                        </div>
                        <!-- Botón para guardar el nuevo comentario -->
                        <button id="guardarComentario" class="btn btn-primary">Guardar Comentario</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para editar un comentario existente -->
        <div class="modal fade" id="editarComentarioModal" tabindex="-1" aria-labelledby="editarComentarioModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <!-- Formulario dentro del modal para editar un comentario -->
                    <form id="editarComentarioForm">
                        <!-- Token CSRF para protección contra ataques de falsificación de solicitudes entre sitios -->
                        {% csrf_token %}
                        <div class="modal-header">
                            <!-- Título del modal -->
                            <h5 class="modal-title" id="editarComentarioModalLabel">Editar Comentario</h5>
                            <!-- Botón para cerrar el modal -->
                            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- Área de texto para editar el comentario -->
                            <div class="form-group">
                                <label for="editarTextoComentario">Comentario</label>
                                <textarea class="form-control" id="editarTextoComentario" rows="4" required></textarea>
                                <!-- Mensaje de retroalimentación en caso de invalidación del campo -->
                                <div class="invalid-feedback">
                                    El comentario no puede estar vacío.
                                </div>
                            </div>
                            <!-- Campo oculto para almacenar el ID del comentario que se está editando -->
                            <input type="hidden" id="editarComentarioId">
                        </div>
                        <div class="modal-footer">
                            <!-- Botón para cancelar la acción y cerrar el modal -->
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                            <!-- Botón para guardar los cambios realizados al comentario -->
                            <button type="submit" class="btn btn-primary" id="guardarEdicionComentario">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para ver detalles de un libro específico -->
        <div class="modal fade" id="detalleLibroModal" tabindex="-1" aria-labelledby="detalleLibroModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <!-- Título del modal -->
                        <h5 class="modal-title" id="detalleLibroModalLabel">Detalles del Libro</h5>
                        <!-- Botón para cerrar el modal -->
                        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Título del libro, será llenado dinámicamente -->
                        <h3 id="detalleTitulo"></h3>
                        <!-- Información adicional del libro, como año de publicación, idioma y autores -->
                        <p><strong>Año de Publicación:</strong> <span id="detalleAnio"></span></p>
                        <p><strong>Idioma:</strong> <span id="detalleIdioma"></span></p>
                        <p><strong>Autores:</strong> <span id="detalleAutores"></span></p>
                    </div>
                    <div class="modal-footer">
                        <!-- Botón para cerrar el modal -->
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enlaces a scripts de JavaScript necesarios para la funcionalidad de la página -->
    <!-- jQuery, necesario para muchas de las librerías utilizadas -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Script de DataTables para mejorar las tablas HTML -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <!-- Script para la versión responsiva de DataTables -->
    <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
    <!-- Script de Bootstrap para funcionalidades interactivas del front-end, como modales y tooltips -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Script de Select2 para mejorar los campos de selección -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            /**
             * Función para obtener el valor de una cookie por su nombre
             * @param {string} name - Nombre de la cookie
             * @returns {string|null} - Valor de la cookie o null si no existe
             */
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const csrftoken = getCookie('csrftoken'); // Obtener el token CSRF almacenado en las cookies

            // Configurar AJAX para incluir automáticamente el token CSRF en las solicitudes no seguras
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    // Si el método HTTP no es seguro y la solicitud no es de otro dominio
                    if (!/^GET|HEAD|OPTIONS|TRACE$/i.test(settings.type) && !this.crossDomain) {
                        // Agrega el encabezado X-CSRFToken con el valor del token CSRF
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            /**
             * Función para mostrar alertas dinámicas en el contenedor de alertas
             * @param {string} tipo - Tipo de alerta ('success', 'danger', 'warning', etc.)
             * @param {string} mensaje - Mensaje que se mostrará en la alerta
             */
            function mostrarAlerta(tipo, mensaje) {
                // Inserta el HTML de la alerta en el contenedor de alertas
                $('#alertContainer').html(`
                    <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                        ${mensaje}
                        <!-- Botón para cerrar la alerta -->
                        <button type="button" class="close" data-dismiss="alert" aria-label="Cerrar">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                `);
            }

            /**
             * Inicializar DataTable para la tabla de autores
             * Solo si el usuario es administrador
             */
            {% if isAdmin %}
            const tablaAutores = $('#tablaAutores').DataTable({
                // Configuración de AJAX para cargar los datos de los autores
                ajax: {
                    url: "{% url 'mi_app:obtener_autores' %}", // URL de la vista de Django que devuelve los autores en formato JSON
                    dataSrc: "" // Indica que los datos están en la raíz del JSON
                },
                // Definición de las columnas de la tabla
                columns: [
                    { data: "id", className: "text-center" }, // Columna de ID, centrada
                    { data: "nombre" }, // Columna de Nombre del Autor
                    {
                        data: null, // No se enlaza directamente a una propiedad del JSON
                        orderable: false, // Desactiva el ordenamiento para esta columna
                        className: "text-center", // Centra el contenido
                        // Renderiza los botones de acción (editar y eliminar) en cada fila
                        render: function (data, type, row) {
                            return `
                                <button class='btn btn-warning btn-sm btn-action btn-edit-author' title="Editar Autor" data-toggle="tooltip">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class='btn btn-danger btn-sm btn-action btn-delete-author' title="Eliminar Autor" data-toggle="tooltip">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            `;
                        }
                    }
                ],
                responsive: true, // Hace que la tabla sea responsiva
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json' // Configuración de idioma en español
                },
                pagingType: "full_numbers", // Tipo de paginación
                lengthMenu: [10, 25, 50, 100], // Opciones para el tamaño de página
                pageLength: 10, // Número predeterminado de elementos por página
                scrollY: "300px", // Altura fija para el desplazamiento vertical
                scrollCollapse: true, // Permite que el desplazamiento colapse si hay menos elementos
                // Definición de la estructura de la tabla (dom) con elementos de Bootstrap
                dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                     "<'row'<'col-sm-12'tr>>" +
                     "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
            });
            {% endif %}

            /**
             * Inicializar DataTable para la tabla de libros
             */
            const tablaLibros = $('#tablaLibros').DataTable({
                // Configuración de AJAX para cargar los datos de los libros
                ajax: {
                    url: "{% url 'mi_app:obtener_libros' %}", // URL de la vista de Django que devuelve los libros en formato JSON
                    dataSrc: "data" // Indica que los datos están dentro de la propiedad "data" del JSON
                },
                // Definición de las columnas de la tabla
                columns: [
                    { data: "id", className: "text-center" }, // Columna de ID, centrada
                    { data: "titulo" }, // Columna de Título del Libro
                    { data: "autores_nombres" }, // Columna de Autores del Libro
                    { data: "anio_publicacion", className: "text-center" }, // Columna de Año de Publicación, centrada
                    { data: "idioma", className: "text-center" }, // Columna de Idioma, centrada
                    {
                        data: null, // No se enlaza directamente a una propiedad del JSON
                        orderable: false, // Desactiva el ordenamiento para esta columna
                        className: "text-center", // Centra el contenido
                        // Renderiza los botones de acción (comentarios, editar, eliminar) en cada fila
                        render: function (data, type, row) {
                            let botones = `
                                <button class='btn btn-info btn-sm btn-action btn-comentarios' title="Comentarios" data-toggle="tooltip">
                                    <i class="fas fa-comments"></i>
                                </button>
                            `;
                            {% if isAdmin %}
                            // Si el usuario es administrador, añade botones para editar y eliminar
                            botones += `
                                <button class='btn btn-warning btn-sm btn-action btn-edit' title="Editar" data-toggle="tooltip">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class='btn btn-danger btn-sm btn-action btn-delete' title="Eliminar" data-toggle="tooltip">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            `;
                            {% endif %}
                            return botones;
                        }
                    }
                ],
                responsive: true, // Hace que la tabla sea responsiva
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json' // Configuración de idioma en español
                },
                pagingType: "full_numbers", // Tipo de paginación
                lengthMenu: [10, 25, 50, 100], // Opciones para el tamaño de página
                pageLength: 10, // Número predeterminado de elementos por página
                scrollY: "400px", // Altura fija para el desplazamiento vertical
                scrollCollapse: true, // Permite que el desplazamiento colapse si hay menos elementos
                // Definición de la estructura de la tabla (dom) con elementos de Bootstrap
                dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                     "<'row'<'col-sm-12'tr>>" +
                     "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
            });

            /**
             * Inicializar DataTable para la tabla de comentarios
             */
            const tablaComentarios = $('#tablaComentarios').DataTable({
                // Configuración de AJAX para cargar los datos de los comentarios
                ajax: {
                    url: "{% url 'mi_app:obtener_todos_comentarios' %}", // URL de la vista de Django que devuelve todos los comentarios en formato JSON
                    dataSrc: "" // Indica que los datos están en la raíz del JSON
                },
                // Definición de las columnas de la tabla
                columns: [
                    { data: "id", className: "text-center" }, // Columna de ID, centrada
                    { data: "libro__titulo" }, // Columna de Título del Libro asociado al comentario
                    { data: "usuario__username" }, // Columna de Nombre de Usuario que realizó el comentario
                    { data: "texto" }, // Columna de Texto del Comentario
                    { data: "fecha", className: "text-center" }, // Columna de Fecha del Comentario, centrada
                    {
                        data: null, // No se enlaza directamente a una propiedad del JSON
                        orderable: false, // Desactiva el ordenamiento para esta columna
                        className: "text-center", // Centra el contenido
                        // Renderiza los botones de acción (editar, eliminar) en cada fila si el usuario es admin o es el autor del comentario
                        render: function (data, type, row) {
                            let botones = "";
                            if (isAdmin || currentUser === row.usuario__username) {
                                botones += `
                                    <button class='btn btn-warning btn-sm btn-action btn-edit-comentario' title="Editar Comentario" data-id="${row.id}" data-toggle="tooltip">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class='btn btn-danger btn-sm btn-action btn-delete-comentario' title="Eliminar Comentario" data-id="${row.id}" data-toggle="tooltip">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                `;
                            }
                            return botones;
                        }
                    }
                ],
                responsive: true, // Hace que la tabla sea responsiva
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json' // Configuración de idioma en español
                },
                pagingType: "full_numbers", // Tipo de paginación
                lengthMenu: [10, 25, 50, 100], // Opciones para el tamaño de página
                pageLength: 10, // Número predeterminado de elementos por página
                scrollY: "300px", // Altura fija para el desplazamiento vertical
                scrollCollapse: true, // Permite que el desplazamiento colapse si hay menos elementos
                // Definición de la estructura de la tabla (dom) con elementos de Bootstrap
                dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                     "<'row'<'col-sm-12'tr>>" +
                     "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
            });

            /**
             * Inicializar Select2 para el campo de selección de autores en el formulario de libros
             */
            $('#autores').select2({
                placeholder: "Selecciona autores", // Texto que se muestra cuando no hay ninguna selección
                ajax: {
                    url: "{% url 'mi_app:buscar_autores' %}", // URL de la vista de Django que devuelve autores en formato JSON según la búsqueda
                    dataType: 'json', // Tipo de datos esperados
                    delay: 250, // Retraso en milisegundos antes de enviar la solicitud
                    data: function (params) {
                        return { q: params.term }; // Parámetros que se envían al servidor, incluyendo el término de búsqueda
                    },
                    processResults: function (data) {
                        return {
                            results: data.results.map(autor => ({ id: autor.id, text: autor.text })) // Procesa los resultados recibidos del servidor para adaptarlos al formato esperado por Select2
                        };
                    },
                    cache: true // Habilita el almacenamiento en caché de los resultados
                },
                minimumInputLength: 1, // Número mínimo de caracteres antes de iniciar la búsqueda
                width: '100%' // Ancho completo del campo de selección
            });

            /**
             * Función para agregar un nuevo autor desde el formulario de administración
             * Solo disponible para administradores
             */
            {% if isAdmin %}
            $('#addAuthorForm').on('submit', function (e) {
                e.preventDefault();  // Evita la recarga de la página al enviar el formulario
                const nombreAutor = $('#nombreAutor').val().trim(); // Obtiene el valor del campo de nombre del autor y elimina espacios en blanco al inicio y final

                if (nombreAutor) { // Verifica que el nombre del autor no esté vacío
                    $.ajax({
                        url: "{% url 'mi_app:agregar_autor' %}", // URL de la vista de Django para agregar un nuevo autor
                        method: 'POST', // Método HTTP
                        contentType: 'application/json', // Tipo de contenido enviado
                        data: JSON.stringify({ nombre: nombreAutor }), // Datos enviados en formato JSON
                        success: function (response) {
                            mostrarAlerta('success', 'Autor agregado correctamente.'); // Muestra una alerta de éxito al usuario
                            $('#nombreAutor').val('');  // Limpia el campo de entrada del formulario
                            tablaAutores.ajax.reload();  // Recarga la tabla de autores para mostrar el nuevo autor agregado
                            $('#autores').trigger('change');  // Actualiza el campo Select2 de autores en el formulario de libros
                        },
                        error: function (xhr) {
                            const error = xhr.responseJSON.error || "Error al agregar autor."; // Obtiene el mensaje de error del servidor o muestra un mensaje genérico
                            mostrarAlerta('danger', error); // Muestra una alerta de error al usuario
                        }
                    });
                } else {
                    mostrarAlerta('danger', "El nombre del autor no puede estar vacío."); // Muestra una alerta de error si el nombre del autor está vacío
                }
            });
            {% endif %}

            /**
             * Evento para abrir el modal de agregar autor desde el formulario de libros
             */
            $('#addAuthorBtn').on('click', function () {
                $('#agregarAutorModal').modal('show'); // Muestra el modal para agregar un nuevo autor
            });

            /**
             * Función para agregar un nuevo autor desde el modal de libros
             */
            $('#agregarAutorFormModal').on('submit', function (e) {
                e.preventDefault(); // Evita la recarga de la página al enviar el formulario
                const nuevoNombreAutor = $('#nuevoNombreAutor').val().trim(); // Obtiene el valor del campo de nombre del nuevo autor y elimina espacios en blanco

                if (nuevoNombreAutor) { // Verifica que el nombre del autor no esté vacío
                    $.ajax({
                        url: "{% url 'mi_app:agregar_autor' %}", // URL de la vista de Django para agregar un nuevo autor
                        method: 'POST', // Método HTTP
                        contentType: 'application/json', // Tipo de contenido enviado
                        data: JSON.stringify({ nombre: nuevoNombreAutor }), // Datos enviados en formato JSON
                        success: function (response) {
                            mostrarAlerta('success', 'Autor agregado correctamente.'); // Muestra una alerta de éxito al usuario
                            $('#nuevoNombreAutor').val('');  // Limpia el campo de entrada del modal
                            $('#agregarAutorModal').modal('hide');  // Cierra el modal después de agregar el autor
                            {% if isAdmin %}
                            tablaAutores.ajax.reload();  // Recarga la tabla de autores si el usuario es administrador
                            {% endif %}
                            // Crea una nueva opción en el campo Select2 y la selecciona automáticamente
                            var newOption = new Option(response.nombre, response.id, true, true);
                            $('#autores').append(newOption).trigger('change');
                        },
                        error: function (xhr) {
                            const error = xhr.responseJSON.error || "Error al agregar autor."; // Obtiene el mensaje de error del servidor o muestra un mensaje genérico
                            mostrarAlerta('danger', error); // Muestra una alerta de error al usuario
                        }
                    });
                } else {
                    mostrarAlerta('danger', "El nombre del autor no puede estar vacío."); // Muestra una alerta de error si el nombre del autor está vacío
                }
            });

            /**
             * Función para editar un autor en la tabla de autores
             * Solo disponible para administradores
             */
            {% if isAdmin %}
            $('#tablaAutores').on('click', '.btn-edit-author', function () {
                const data = tablaAutores.row($(this).parents('tr')).data(); // Obtiene los datos de la fila seleccionada
                const autorId = data.id; // Obtiene el ID del autor
                const nombreActual = data.nombre; // Obtiene el nombre actual del autor

                // Solicita al usuario el nuevo nombre del autor mediante un prompt
                const nuevoNombre = prompt("Editar nombre del autor:", nombreActual);
                if (nuevoNombre && nuevoNombre.trim() !== "") { // Verifica que el usuario haya ingresado un nuevo nombre y que no esté vacío
                    $.ajax({
                        url: "{% url 'mi_app:editar_autor' autor_id=0 %}".replace('/0/', `/${autorId}/`), // URL de la vista de Django para editar el autor, reemplazando el ID dinámicamente
                        method: 'POST', // Método HTTP
                        contentType: 'application/json', // Tipo de contenido enviado
                        data: JSON.stringify({ nombre: nuevoNombre }), // Datos enviados en formato JSON
                        success: function () {
                            mostrarAlerta('success', 'Autor actualizado correctamente.'); // Muestra una alerta de éxito al usuario
                            tablaAutores.ajax.reload(); // Recarga la tabla de autores para reflejar los cambios
                            tablaLibros.ajax.reload(); // Recarga la tabla de libros para actualizar los nombres de autores si están visibles
                            tablaComentarios.ajax.reload(); // Recarga la tabla de comentarios para mantener la consistencia
                            $('#autores').trigger('change'); // Actualiza el campo Select2 de autores en el formulario de libros
                        },
                        error: function (xhr) {
                            const error = xhr.responseJSON.error || "Error al editar autor."; // Obtiene el mensaje de error del servidor o muestra un mensaje genérico
                            mostrarAlerta('danger', "Error al editar autor: " + error); // Muestra una alerta de error al usuario
                        }
                    });
                } else if (nuevoNombre !== null) { // Si el usuario canceló el prompt o dejó el nombre vacío
                    mostrarAlerta('warning', "El nombre del autor no puede estar vacío."); // Muestra una alerta de advertencia
                }
            });

            /**
             * Función para eliminar un autor en la tabla de autores
             * Solo disponible para administradores
             */
            $('#tablaAutores').on('click', '.btn-delete-author', function () {
                const data = tablaAutores.row($(this).parents('tr')).data(); // Obtiene los datos de la fila seleccionada
                const autorId = data.id; // Obtiene el ID del autor
                const nombreAutor = data.nombre; // Obtiene el nombre del autor
                // Solicita confirmación al usuario antes de eliminar
                if (confirm(`¿Estás seguro de eliminar al autor "${nombreAutor}"?`)) {
                    $.ajax({
                        url: "{% url 'mi_app:eliminar_autor' autor_id=0 %}".replace('/0/', `/${autorId}/`), // URL de la vista de Django para eliminar el autor, reemplazando el ID dinámicamente
                        method: 'POST', // Método HTTP
                        success: function () {
                            mostrarAlerta('success', "Autor eliminado correctamente."); // Muestra una alerta de éxito al usuario
                            tablaAutores.ajax.reload(); // Recarga la tabla de autores para reflejar la eliminación
                            tablaLibros.ajax.reload(); // Recarga la tabla de libros para actualizar los nombres de autores si están visibles
                            tablaComentarios.ajax.reload(); // Recarga la tabla de comentarios para mantener la consistencia
                            $('#autores').trigger('change'); // Actualiza el campo Select2 de autores en el formulario de libros
                        },
                        error: function (xhr) {
                            const error = xhr.responseJSON.error || "Error al eliminar autor."; // Obtiene el mensaje de error del servidor o muestra un mensaje genérico
                            mostrarAlerta('danger', "Error al eliminar autor: " + error); // Muestra una alerta de error al usuario
                        }
                    });
                }
            });
            {% endif %}

            /**
             * Función para agregar un nuevo libro desde el formulario
             */
            $('#addBookForm').on('submit', function (e) {
                e.preventDefault(); // Previene el comportamiento por defecto del formulario (recarga de la página)
                const titulo = $('#titulo').val().trim(); // Obtiene el valor del campo de título y elimina espacios en blanco
                const anioPublicacion = $('#anio_publicacion').val().trim(); // Obtiene el valor del campo de año de publicación y elimina espacios en blanco
                const idioma = $('#idioma').val().trim(); // Obtiene el valor del campo de idioma y elimina espacios en blanco
                const autores = $('#autores').val(); // Obtiene los IDs de los autores seleccionados

                // Verifica que todos los campos estén completos y al menos un autor esté seleccionado
                if (titulo && anioPublicacion && idioma && autores.length > 0) {
                    $.ajax({
                        url: "{% url 'mi_app:agregar_libro' %}", // URL de la vista de Django para agregar un nuevo libro
                        method: 'POST', // Método HTTP
                        contentType: 'application/json', // Tipo de contenido enviado
                        data: JSON.stringify({
                            titulo: titulo,
                            anio_publicacion: anioPublicacion,
                            idioma: idioma,
                            autores: autores
                        }), // Datos enviados en formato JSON
                        success: function (response) {
                            mostrarAlerta('success', response.mensaje); // Muestra una alerta de éxito al usuario
                            $('#addBookForm')[0].reset(); // Resetea el formulario después de agregar el libro
                            $('#autores').val(null).trigger('change'); // Resetea el campo Select2 de autores
                            tablaLibros.ajax.reload(); // Recarga la tabla de libros para mostrar el nuevo libro agregado
                            tablaComentarios.ajax.reload(); // Recarga la tabla de comentarios para mantener la consistencia
                        },
                        error: function (xhr) {
                            const error = xhr.responseJSON.error || "Error al agregar libro."; // Obtiene el mensaje de error del servidor o muestra un mensaje genérico
                            mostrarAlerta('danger', "Error al agregar libro: " + error); // Muestra una alerta de error al usuario
                        }
                    });
                } else {
                    mostrarAlerta('warning', "Por favor, completa todos los campos del formulario."); // Muestra una alerta de advertencia si faltan campos por completar
                }
            });

            {% if isAdmin %}
            /**
             * Evento para editar un libro en la tabla de libros
             * Solo disponible para administradores
             */
            $('#tablaLibros').on('click', '.btn-edit', function () {
                const data = tablaLibros.row($(this).parents('tr')).data(); // Obtiene los datos de la fila seleccionada
                const libroId = data.id; // Obtiene el ID del libro
                const tituloActual = data.titulo; // Obtiene el título actual del libro
                const anioActual = data.anio_publicacion; // Obtiene el año de publicación actual del libro
                const idiomaActual = data.idioma; // Obtiene el idioma actual del libro
                const autoresActuales = data.autores_nombres.split(", ").map(nombre => nombre.trim()); // Obtiene los autores actuales y los separa en un array

                // Solicita al usuario los nuevos valores mediante prompts
                const nuevoTitulo = prompt("Editar título del libro:", tituloActual);
                const nuevoAnio = prompt("Editar año de publicación:", anioActual);
                const nuevoIdioma = prompt("Editar idioma:", idiomaActual);

                // Verifica que todos los campos hayan sido completados
                if (nuevoTitulo && nuevoTitulo.trim() !== "" &&
                    nuevoAnio && nuevoAnio.trim() !== "" &&
                    nuevoIdioma && nuevoIdioma.trim() !== "") {

                    // Obtener IDs de los autores seleccionados
                    // Para simplificar, asumimos que los autores no cambian
                    const autores = data.autores_nombres.split(", ").map(nombre => nombre.trim());
                    // En una implementación más avanzada, podrías permitir editar los autores también

                    // Realiza una solicitud AJAX para editar el libro
                    $.ajax({
                        url: "{% url 'mi_app:editar_libro' libro_id=0 %}".replace('/0/', `/${libroId}/`), // URL de la vista de Django para editar el libro, reemplazando el ID dinámicamente
                        method: 'POST', // Método HTTP
                        contentType: 'application/json', // Tipo de contenido enviado
                        data: JSON.stringify({
                            titulo: nuevoTitulo,
                            anio_publicacion: nuevoAnio,
                            idioma: nuevoIdioma,
                            autores: autores
                        }), // Datos enviados en formato JSON
                        success: function () {
                            mostrarAlerta('success', 'Libro actualizado correctamente.'); // Muestra una alerta de éxito al usuario
                            tablaLibros.ajax.reload(); // Recarga la tabla de libros para reflejar los cambios
                            tablaComentarios.ajax.reload(); // Recarga la tabla de comentarios para mantener la consistencia
                        },
                        error: function (xhr) {
                            const error = xhr.responseJSON.error || "Error al editar libro."; // Obtiene el mensaje de error del servidor o muestra un mensaje genérico
                            mostrarAlerta('danger', "Error al editar libro: " + error); // Muestra una alerta de error al usuario
                        }
                    });
                } else {
                    mostrarAlerta('warning', "Todos los campos deben estar llenos para editar el libro."); // Muestra una alerta de advertencia si faltan campos por completar
                }
            });

            /**
             * Evento para eliminar un libro en la tabla de libros
             * Solo disponible para administradores
             */
            $('#tablaLibros').on('click', '.btn-delete', function () {
                const data = tablaLibros.row($(this).parents('tr')).data(); // Obtiene los datos de la fila seleccionada
                const libroId = data.id; // Obtiene el ID del libro
                const tituloLibro = data.titulo; // Obtiene el título del libro
                // Solicita confirmación al usuario antes de eliminar
                if (confirm(`¿Estás seguro de eliminar el libro "${tituloLibro}"?`)) {
                    $.ajax({
                        url: "{% url 'mi_app:eliminar_libro' libro_id=0 %}".replace('/0/', `/${libroId}/`), // URL de la vista de Django para eliminar el libro, reemplazando el ID dinámicamente
                        method: 'POST', // Método HTTP
                        success: function () {
                            mostrarAlerta('success', 'Libro eliminado correctamente.'); // Muestra una alerta de éxito al usuario
                            tablaLibros.ajax.reload(); // Recarga la tabla de libros para reflejar la eliminación
                            tablaComentarios.ajax.reload(); // Recarga la tabla de comentarios para mantener la consistencia
                        },
                        error: function (xhr) {
                            const error = xhr.responseJSON.error || "Error al eliminar libro."; // Obtiene el mensaje de error del servidor o muestra un mensaje genérico
                            mostrarAlerta('danger', "Error al eliminar libro: " + error); // Muestra una alerta de error al usuario
                        }
                    });
                }
            });
            {% endif %}

            /**
             * Función para renderizar un comentario en la lista del modal
             * @param {Object} comentario - Objeto que contiene los datos del comentario
             * @returns {string} - HTML formateado para el comentario
             */
            function renderComentario(comentario) {
                const esAutor = (currentUser === comentario.usuario__username || isAdmin); // Verifica si el usuario actual es el autor del comentario o un administrador
                // Define los botones de acción disponibles según el rol del usuario
                const acciones = esAutor ? `
                    <button class="btn btn-sm btn-warning btn-edit-comentario mr-2" data-id="${comentario.id}" data-toggle="tooltip" data-texto="${comentario.texto}" title="Editar Comentario">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger btn-delete-comentario" data-id="${comentario.id}" title="Eliminar Comentario" data-toggle="tooltip">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                ` : '';

                // Retorna el HTML del comentario formateado
                return `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${comentario.usuario__username}</strong>: ${comentario.texto}
                            </div>
                            <div>
                                ${acciones}
                            </div>
                        </div>
                    </li>
                `;
            }

            /**
             * Función para cargar los comentarios de un libro específico en el modal
             * @param {number} libroId - ID del libro cuyos comentarios se desean cargar
             */
            function cargarComentarios(libroId) {
                // Realiza una solicitud AJAX para obtener los comentarios del libro
                $.ajax({
                    url: "{% url 'mi_app:obtener_comentarios' libro_id=0 %}".replace('/0/', `/${libroId}/`), // URL de la vista de Django que devuelve comentarios para un libro específico
                    method: 'GET', // Método HTTP
                    success: function (response) {
                        $('#comentariosList').empty(); // Limpia la lista actual de comentarios
                        response.forEach(comentario => {
                            $('#comentariosList').append(renderComentario(comentario)); // Agrega cada comentario a la lista
                        });
                        // Inicializa los tooltips dentro del modal para los nuevos botones
                        $('#comentariosModal [data-toggle="tooltip"]').tooltip();
                    },
                    error: function () {
                        mostrarAlerta('danger', "Error al cargar comentarios."); // Muestra una alerta de error si no se pueden cargar los comentarios
                    }
                });
            }

            /**
             * Abrir modal de comentarios al hacer clic en el botón correspondiente de una fila de libro
             */
            $('#tablaLibros').on('click', '.btn-comentarios', function () {
                const data = tablaLibros.row($(this).parents('tr')).data(); // Obtiene los datos de la fila seleccionada
                const libroId = data.id; // Obtiene el ID del libro
                $('#comentariosModal').data('libro-id', libroId); // Asigna el ID del libro al modal para referencia futura
                cargarComentarios(libroId); // Carga los comentarios del libro en el modal
                $('#comentariosModal').modal('show'); // Muestra el modal de comentarios
            });

            /**
             * Agregar un nuevo comentario desde el modal
             */
            $('#guardarComentario').on('click', function () {
                const libroId = $('#comentariosModal').data('libro-id'); // Obtiene el ID del libro del cual se están agregando comentarios
                const comentarioTexto = $('#nuevoComentario').val().trim(); // Obtiene el texto del nuevo comentario y elimina espacios en blanco

                // Verifica que el comentario no esté vacío
                if (comentarioTexto) {
                    // Realiza una solicitud AJAX para agregar el comentario
                    $.ajax({
                        url: "{% url 'mi_app:agregar_comentario' libro_id=0 %}".replace('/0/', `/${libroId}/`), // URL de la vista de Django para agregar un comentario al libro
                        method: 'POST', // Método HTTP
                        contentType: 'application/json', // Tipo de contenido enviado
                        data: JSON.stringify({ texto: comentarioTexto }), // Datos enviados en formato JSON
                        success: function (response) {
                            mostrarAlerta('success', response.mensaje); // Muestra una alerta de éxito al usuario
                            $('#nuevoComentario').val(''); // Limpia el campo de entrada del comentario
                            cargarComentarios(libroId); // Vuelve a cargar los comentarios del libro para incluir el nuevo
                            tablaComentarios.ajax.reload(); // Recarga la tabla principal de comentarios para mantener la consistencia
                        },
                        error: function (xhr) {
                            const error = xhr.responseJSON.error || "Error al agregar comentario."; // Obtiene el mensaje de error del servidor o muestra un mensaje genérico
                            mostrarAlerta('danger', error); // Muestra una alerta de error al usuario
                        }
                    });
                } else {
                    mostrarAlerta('warning', "Por favor, escribe un comentario antes de guardar."); // Muestra una alerta de advertencia si el comentario está vacío
                }
            });

            /**
             * Delegación de eventos para editar y eliminar comentarios dentro del modal de comentarios
             */
            $('#comentariosModal').on('click', '.btn-edit-comentario', function () {
                const comentarioId = $(this).data('id'); // Obtiene el ID del comentario que se desea editar
                const comentarioTexto = $(this).data('texto'); // Obtiene el texto del comentario desde el atributo data-texto

                // Asigna el texto actual del comentario al área de edición
                $('#editarTextoComentario').val(comentarioTexto);
                // Asigna el ID del comentario al campo oculto para referencia al guardar
                $('#editarComentarioId').val(comentarioId);
                // Muestra el modal para editar el comentario
                $('#editarComentarioModal').modal('show');
            });

            $('#comentariosModal').on('click', '.btn-delete-comentario', function () {
                const comentarioId = $(this).data('id'); // Obtiene el ID del comentario que se desea eliminar

                // Solicita confirmación al usuario antes de eliminar
                if (confirm('¿Estás seguro de eliminar este comentario?')) {
                    // Realiza una solicitud AJAX para eliminar el comentario
                    $.ajax({
                        url: "{% url 'mi_app:eliminar_comentario' comentario_id=0 %}".replace('/0/', `/${comentarioId}/`), // URL de la vista de Django para eliminar el comentario, reemplazando el ID dinámicamente
                        method: 'POST', // Método HTTP
                        success: function () {
                            mostrarAlerta('success', "Comentario eliminado correctamente."); // Muestra una alerta de éxito al usuario
                            const libroId = $('#comentariosModal').data('libro-id'); // Obtiene el ID del libro para recargar los comentarios
                            cargarComentarios(libroId); // Vuelve a cargar los comentarios del libro
                            tablaComentarios.ajax.reload(); // Recarga la tabla principal de comentarios para mantener la consistencia
                        },
                        error: function (xhr) {
                            const error = xhr.responseJSON.error || "Error al eliminar el comentario."; // Obtiene el mensaje de error del servidor o muestra un mensaje genérico
                            mostrarAlerta('danger', "Error al eliminar el comentario: " + error); // Muestra una alerta de error al usuario
                        }
                    });
                }
            });

            /**
             * Guardar los cambios al editar un comentario desde el modal de edición
             */
            $('#guardarEdicionComentario').on('click', function () {
                const comentarioId = $('#editarComentarioId').val(); // Obtiene el ID del comentario que se está editando
                const nuevoTexto = $('#editarTextoComentario').val().trim(); // Obtiene el nuevo texto del comentario y elimina espacios en blanco

                // Verifica que el nuevo texto no esté vacío
                if (nuevoTexto) {
                    // Realiza una solicitud AJAX para editar el comentario
                    $.ajax({
                        url: "{% url 'mi_app:editar_comentario' comentario_id=0 %}".replace('/0/', `/${comentarioId}/`), // URL de la vista de Django para editar el comentario, reemplazando el ID dinámicamente
                        method: 'POST', // Método HTTP
                        contentType: 'application/json', // Tipo de contenido enviado
                        data: JSON.stringify({ texto: nuevoTexto }), // Datos enviados en formato JSON
                        success: function () {
                            mostrarAlerta('success', "Comentario editado correctamente."); // Muestra una alerta de éxito al usuario
                            $('#editarComentarioModal').modal('hide'); // Cierra el modal de edición
                            const libroId = $('#comentariosModal').data('libro-id'); // Obtiene el ID del libro para recargar los comentarios
                            cargarComentarios(libroId); // Vuelve a cargar los comentarios del libro
                            tablaComentarios.ajax.reload(); // Recarga la tabla principal de comentarios para mantener la consistencia
                        },
                        error: function (xhr) {
                            const error = xhr.responseJSON.error || "Error al editar comentario."; // Obtiene el mensaje de error del servidor o muestra un mensaje genérico
                            mostrarAlerta('danger', "Error al editar comentario: " + error); // Muestra una alerta de error al usuario
                        }
                    });
                } else {
                    mostrarAlerta('warning', "El comentario no puede estar vacío."); // Muestra una alerta de advertencia si el nuevo texto del comentario está vacío
                }
            });

            /**
             * Manejadores de eventos para editar y eliminar comentarios en la tabla principal de comentarios
             */
            $('#tablaComentarios').on('click', '.btn-edit-comentario', function () {
                const comentarioId = $(this).data('id'); // Obtiene el ID del comentario que se desea editar
                const data = tablaComentarios.row($(this).parents('tr')).data(); // Obtiene los datos del comentario desde la tabla
                const comentarioTexto = data.texto; // Obtiene el texto del comentario

                // Asigna el texto actual del comentario al área de edición
                $('#editarTextoComentario').val(comentarioTexto);
                // Asigna el ID del comentario al campo oculto para referencia al guardar
                $('#editarComentarioId').val(comentarioId);
                // Muestra el modal para editar el comentario
                $('#editarComentarioModal').modal('show');
            });

            $('#tablaComentarios').on('click', '.btn-delete-comentario', function () {
                const comentarioId = $(this).data('id'); // Obtiene el ID del comentario que se desea eliminar

                // Solicita confirmación al usuario antes de eliminar
                if (confirm('¿Estás seguro de eliminar este comentario?')) {
                    // Realiza una solicitud AJAX para eliminar el comentario
                    $.ajax({
                        url: "{% url 'mi_app:eliminar_comentario' comentario_id=0 %}".replace('/0/', `/${comentarioId}/`), // URL de la vista de Django para eliminar el comentario, reemplazando el ID dinámicamente
                        method: 'POST', // Método HTTP
                        success: function () {
                            mostrarAlerta('success', "Comentario eliminado correctamente."); // Muestra una alerta de éxito al usuario
                            tablaComentarios.ajax.reload(); // Recarga la tabla principal de comentarios para reflejar la eliminación
                        },
                        error: function (xhr) {
                            const error = xhr.responseJSON.error || "Error al eliminar el comentario."; // Obtiene el mensaje de error del servidor o muestra un mensaje genérico
                            mostrarAlerta('danger', "Error al eliminar el comentario: " + error); // Muestra una alerta de error al usuario
                        }
                    });
                }
            });

            {% if isAdmin %}
            /**
             * Evento para editar un autor en la tabla de autores
             * (Este código ya ha sido eliminado para evitar duplicación)
             */
            {% endif %}

            /**
             * Toggle para Tema Oscuro
             */
            $('#toggleDarkMode').on('change', function () {
                if ($(this).is(':checked')) { // Verifica si el interruptor está activado (tema oscuro)
                    $('body').addClass('dark-mode'); // Agrega la clase 'dark-mode' al cuerpo para activar los estilos de modo oscuro
                    localStorage.setItem('theme', 'dark'); // Guarda la preferencia de tema en el almacenamiento local del navegador
                } else {
                    $('body').removeClass('dark-mode'); // Elimina la clase 'dark-mode' del cuerpo para volver al modo claro
                    localStorage.setItem('theme', 'light'); // Actualiza la preferencia de tema en el almacenamiento local del navegador
                }
            });

            // Verificar la preferencia de tema almacenada en el almacenamiento local al cargar la página
            if (localStorage.getItem('theme') === 'dark') {
                $('body').addClass('dark-mode'); // Si la preferencia es modo oscuro, agrega la clase 'dark-mode' al cuerpo
                $('#toggleDarkMode').prop('checked', true); // Activa el interruptor de tema oscuro
            }

            /**
             * Implementar tooltips de Bootstrap en todos los elementos que los requieran
             */
            $('[data-toggle="tooltip"]').tooltip(); // Inicializa los tooltips en todos los elementos con el atributo data-toggle="tooltip"
        });
    </script>
</body>
</html>
